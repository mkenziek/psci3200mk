---
title: "Assignment 1"
author: "Makenzie Kerneckel"

institute: "University of Pennsylvania"
date: last-modified
toc: true

format: 
  html:
    self-contained: true

editor: source
---

In this assignment, you will be required to:

Create index variables to summarize variation on key outcomes
Estimate and interpret linear models and interaction effects
Describe your reasoning and demonstrate understanding of core concepts
We are using a representative survey of students from Addis Ababa University in Ethiopia collected by DevLab researchers. This data contains two waves collected in May-June and October-November of 2022. A total of 825 students completed both waves of the survey. This data was part of a randomized experiment inviting students to participate in a one-day workshop that connected them with opportunities to interact with leaders of civil society, sign-up as volunteers in civil society organizations, and engage in structured dialogue about politics with a diverse group of peers.

# Part 1: Read-in data and prepare for analysis

```{r }
library(ggplot2)
library(readr)
library(ggdag)
library(tidyverse)
library(gt)
library(modelsummary)

# read-in data
# dat = read_csv(here::here("workshops/aau_survey/clean_endline_did.csv" )) %>%
dat = read_csv("https://raw.githubusercontent.com/jrspringman/psci3200-globaldev/main/workshops/aau_survey/clean_endline_did.csv" ) %>%
    # clean home region variable
  mutate(q8_baseline = ifelse(q8_baseline == "Southern Nations, Nationalities, and Peoples Region", "SNNPR", q8_baseline), 
         q8_baseline = str_remove(q8_baseline, " Region"))
# create color palette for plotting
palette = MetBrewer::met.brewer(name = "Cross")

```



The dataset has a number of variables that you might use for the assignment. For each respondent, we have two observations made at different points in time (baseline and endline). The dataset is currently in ‘wide’ format, meaning that each respondent has one row and baseline and endline measurements for the same variable are stored in separate columns. Measurements taken at baseline have the suffix _baseline included in the column name; for example, q11_3 is the endline measurement and q11_3_baseline is the baseline measurement.

Some of these variables are described below:

response_id: A unique identifier for each respondent
treatment_status: A binary indicator taking a value of 1 for respondents assigned to receive an invitation to the treatment workshop
user_language: A categorical variable indicating whether the respondent took the survey in English, Ahmaric, or Afan
q3_baseline: A categorical variable indicating whether the respondent identifies as Male or Female
Future plans for a career in public sector or civil society
q26_civ: Plan to work in civil society
q26_politics: Plan to work in politics
q26_public: Plan to work in public sector
q27_1: Plan to run for political office
q27_3: Plan to start a non-governmental organization
Feelings of political efficacy
q17_3: Your participation can bring positive change
q17_1: Youth are given opportunities to engage
q17_2: Youth participation can bring positive change

# Requirement 1 (10%)

For all variables after user_language, please rename the column with a descriptive name that better conveys their meaning. Column names should never contain spaces and should be as easy to type as possible. Do this for both their baseline and endline values, making sure to indicate which columns are baseline measures and which are endline measures in the names you assign.

```{R}

# rename and select responseid ,gender,q26, q27, q 17 columns 

dat <- dat %>%
 select(1,"gender_base" = "q3_baseline",
         "civil_base" = "q26_civ_baseline",
         "politics_base" = "q26_politics_baseline",
         "public_base" = "q26_public_baseline",
         "poloffice_base" =  "q27_1_baseline",
         "ngo_base" = "q27_3_baseline",
         "positive_indv_base" = "q17_3_baseline",
         "youth_engage_base" = "q17_1_baseline",
         "positive_youth_base" = "q17_2_baseline",
         "civil_end" = "q26_civ",
         "politics_end" = "q26_politics",
         "public_end" = "q26_public",
         "poloffice_end" = "q27_1",
         "ngo_end" = "q27_3",
         "positive_indv_end" = "q17_3",
         "youth_engage_end" = "q17_1",
         "positive_youth_end" = "q17_2",
         )


``` 


Part 2: Create Index Measures
Next, you’ll need to create index measures for different types of variables. We will use the two types of index methods described during the in-class workshop.

Requirement 2 (10%)

First, in your own words, explain the concept of an additive index and an averaged z-score, including how they are calculated, when you should use them, and when you cannot use them. What are the benefits of each approach?

- An additive index adds individual values or variables into a single score. It should be used when you have many variables measuring a single concept and these variables are measured on a common scale. This can be for outcome, treatment, and covariate variables. The main benefits of the additive index are that it simplifies graphs and hypotheses by condensing multiple variables into one metric. This makes it easier to compare individuals or groups. 
  - To calculate an additive scale you simply sum across columns (index = col_1 + col_2...).
- A z-score tells you the number of standard deviations a value is from the mean of the given distribution of your data. It is thus a standardized score. An averaged z-score combines each standardized score for your values by averaging them. Average z-scores should be used when variables have different scales or when variables cannot be summed in a dataset.  
  - To calculate an averaged z-score, you first standardize the scores for each variable (subtract the mean and divide by the standard deviation), then you average these standardized scores.

Requirement 3 (20%)

Next, you’ll need to:

Create an additive index for the baseline and endline measures of the “Future plans for a career in public sector or civil society” variables. This should correspond to seperate counts of the number of future plans that each individual has at baseline and endline.

```{R}

# convert future plans columns into binary values of 1 and 0 using as.logical 

eth_svy <- dat %>% 
  mutate(across(c(3:7), ~+as.logical(.x))) %>%
  mutate(across(c(11:15), ~+as.logical(.x))) 

# create an additive index variable called add_plans for baseline and endline 

# in this case na values represent no anwser so we drop them from the sum

eth_svy <- eth_svy %>%
  # baseline sums across all future plans questions at baseline 
  mutate(add_plans_end =  rowSums(across(11:15), na.rm = T)) %>%
  # baseline sums across all future plans questions at baseline 
  mutate(add_plans_base =  rowSums(across(3:7), na.rm = T))



```

Create an averaged z-scores for the baseline and endline values of the “Future plans for a career in public sector or civil society” and “Feelings of political efficacy” variables.
Note

```{R}

#| echo: false
#| warning: false



# create a list of baseline column names 

# select all the columns with base in the name

bcols = grep("base", names(eth_svy), value = T)

# drop gender_base

bcols = bcols[-c(1)]

eth_svy[, paste0(bcols, "_st")] = eth_svy[, bcols]

bcols = paste0(bcols,"_st")

# do the procedure above but for endline

ecols = grep("base", names(eth_svy), value = T, invert = T) 

# invert function gives everything without base in the name

# drop response id column 

ecols = ecols[-c(1)]

eth_svy[, paste0(ecols, "_st")] = eth_svy[, ecols]

ecols = paste0(ecols,"_st")


# Modified z-score function
z_score <- function(x) {
  mean_val <- mean(x, na.rm = TRUE)
  sd_val <- sd(x, na.rm = TRUE)
  (x - mean_val) / sd_val
}

# Calculate z-scores using a loop
for (i in c(bcols, ecols)) {
  eth_svy[[i]] <- z_score(eth_svy[[i]])
}
# create average z-score columns 

eth_svy <- eth_svy %>% 
  rowwise() %>% 
  # avg. z score for future plans question endline 
  mutate( z_future_end = mean(c_across(all_of(ecols[1:5])), na.rm = TRUE)) %>% 
  # avg. z score for future plans question baseline 
  mutate( z_future_base = mean(c_across(all_of(bcols[1:5])), na.rm = TRUE)) %>%
  # avg. z score for political question endline 
  mutate( z_pol_end = mean(c_across(all_of(ecols[6:8])), na.rm = TRUE)) %>% 
  # avg. z score for political question baseline 
  mutate( z_pol_base = mean(c_across(all_of(bcols[6:8])), na.rm = TRUE)) %>%
  ungroup()

      
```


Requirement 4 (20%)

To make sure that these scores look as you’d expect, create a ggplot visualizing the distribution of the z-scores at baseline and endline. You should have 4 figures: one corresponding to each z-score at baseline and endline. In words, describe whether the figures tell us anything about changes over time.


```{R}

# create four histograms to show endline and baseline distribution on average z scores for future plans and political question


ggplot(eth_svy , aes(x = z_future_base )) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), 
                 binwidth= 0.5, fill = palette[9]) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Percent of respondents", x = NULL, 
       title = "Distriubtion of Public Sector or Civil Society Career Plans (Baseline)") +
  # Add a vertical line at the mean value of the data with a red dashed line
  geom_vline(xintercept = mean(eth_svy$z_future_base, na.rm = T), col = 'red', lwd = 1, linetype = 'dashed')



ggplot(eth_svy , aes(x = z_future_end )) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), 
                 binwidth= 0.5, fill = palette[9]) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Percent of respondents", x = NULL, 
      title = "Distriubtion of Public Sector or Civil Society Career Plans (Endline)") +
  # Add a vertical line at the mean value of the data with a red dashed line
  geom_vline(xintercept = mean(eth_svy$z_future_end, na.rm = T), col = 'red', lwd = 1, linetype = 'dashed')




ggplot(eth_svy , aes(x = z_pol_base )) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), 
                 binwidth=0.5, fill = palette[9]) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Percent of respondents", x = NULL, 
       title = "Feelings of political efficacy (Baseline)") +
     # Add a vertical line at the mean value of the data with a red dashed line
  geom_vline(xintercept = mean(eth_svy$z_pol_base, na.rm = T), col = 'red', lwd = 1, linetype = 'dashed')



 
ggplot(eth_svy , aes(x = z_pol_end )) + 
  geom_histogram(aes(y = after_stat(count / sum(count))), 
                 binwidth=0.5, fill = palette[9]) +
  scale_y_continuous(labels = scales::percent) +
  labs(y = "Percent of respondents", x = NULL, 
      title = "Feelings of political efficacy (Endline)") +
   # Add a vertical line at the mean value of the data with a red dashed line
  geom_vline(xintercept = mean(eth_svy$z_pol_end, na.rm = T), col = 'red', lwd = 1, linetype = 'dashed')
      



```

- Given that this survey data contains two waves, the baseline histograms represent student responses collected in May-June whereas the endline histograms represent student responses collected in October-November of 2022. 

- In words, describe whether the figures tell us anything about changes over time.

- The baseline and endline histograms for question 26 and 27 on how students' future plans in having a public sector or civil society career show that the average Z-score increased from approximately -0.6 to -0.45. This means that on average, a student in the spring of 2022 had a Z-score measuring whether they will have a future career in the public or civil sector -0.6 standard deviations below the mean and students in fall of 2022 had a Z-score measuring whether they will have a future career in the public or civil sector standard -0.45 standard deviations below the mean. We can conclude that the


- The baseline and endline histograms for question 17 on how students feel about youth political efficacy show that the average Z-score increased from approximately 1.2 to 1.6. This means that on average, students in the spring of 2022 had a Z-score measuring their feeling of political efficacy 1.2 standard deviations above the mean and students in fall of 2022 had a Z-score measuring their feeling of political efficacy 1.6 standard deviations above the mean. We can conclude that the feelings of political efficacy thus increased over time. 



Part 3: Estimating models

Now, let’s estimate some models to assess the relationship between the two index measures. Before we get started, subset your data to include only response_id, q3_baseline (which you should have renamed), and the baseline and endline measures for each z-score. You should end up with 6 variables in your dataframe.

```{r}

# select 6 variables needed, create new dataset for modeling 

eth_model <- eth_svy %>%
             select( response_id, 
                     gender_base, 
                     z_future_end, 
                     z_future_base,
                     z_pol_end,
                     z_pol_base)

```


Requirement 5 (15%)


Using baseline values only, estimate a model regressing your “Future plans” index on your “Feelings of political efficacy” index. Your model should take the following form:

Use the modelsummary()package to visualize the results as a table. In your own words, interpret the meaning of 
 and 
. Substantively, how should we interpret the relationship described in the data? What does this tell us about the world? What assumptions would we need in order to interpret the relationship as causal?

```{r}

pol_model <- list()
pol_model[['Bivariate']] = lm(z_future_base ~ z_pol_base, eth_model)

modelsummary(
  pol_model,
  estimate  = "{estimate}{stars} ({std.error})",
             statistic = NULL,
  gof_omit = 'IC|RMSE|Log|F|R2$|Std.')


```

Requirement 6 (15%)

For your baseline and endline values of the “Feelings of political efficacy” index, convert this index to a binary indicator taking a value of 1 of the individual has a value greater than or equal to the sample mean and a value of 0 if the individual has a value below the sample mean.

Using baseline values only, estimate the same model, but interact your binary “Feelings of political efficacy” indicator with the gender indicator. Your model should take the following form:

Use the modelsummary()package to visualize the results as a table. In your own words, interpret the meaning of and Substantively, how should we interpret the interactive relationship described in the data?

```{r}

eth_model <- eth_model %>%
             mutate(bi_pol_end = ifelse(z_pol_end >= 0, 1,0),
                    bi_pol_base = ifelse(z_pol_base > 0, 1,0))

# help 

bi_pol_model <- list()
bi_pol_model[['Multivariate']] = lm(z_future_base ~ bi_pol_base*gender_base, eth_model)

modelsummary(
  bi_pol_model,
  estimate  = "{estimate}{stars} ({std.error})",
             statistic = NULL,
  gof_omit = 'IC|RMSE|Log|F|R2$|Std.')

# why is only male showing in the model
            
```

Requirement 7 (10%)

Convert the data from ‘wide’ to ‘long’ format, so that each respondent (response_id) has two rows of data; one row is baseline and one row is endline.

Using this new ‘long’ format, estimate the original model, but add unit (response_id) fixed effects. Your model should take the following form:


In your own words, tell us how the meaning of 
 has changed now that we’ve added fixed effects.
 
```{r}

eth_model_long <- eth_model %>%
  pivot_longer(cols = c(z_pol_end, z_pol_base, z_future_end, z_future_base),
               names_to = c(".value", "time"),
               names_pattern = "z_(\\w+)_(\\w+)",
               values_to = c("z_pol", "z_future")) %>%
  mutate(time = ifelse(time == "end", 1, 0))


fixed_model <- list()
fixed_model[['Fixed Effects']] = lm(future ~ pol + time + factor(response_id), eth_model_long)

modelsummary(
  fixed_model,
  coef_omit = "factor\\(.*",
  estimate  = "{estimate}{stars} ({std.error})",
             statistic = NULL,
  gof_omit = 'IC|RMSE|Log|F|R2$|Std.')

```
 
 
 
 